---
import "../styles/main.css";

// expone URL sin “hardcodearla”
const apiBase = import.meta.env.PUBLIC_API_BASE ?? "";
// Dataset de ejemplo para demo del grafo (puedes reemplazar con fetch al backend)
const demoCities = [
  { id: 1, name: 'Toluca', lat: 19.28, lon: -99.65 },
  { id: 2, name: 'CDMX',   lat: 19.43, lon: -99.13 },
  { id: 3, name: 'Puebla', lat: 19.04, lon: -98.21 }
];
const demoEdges = [
  { fromId: 1, toId: 2, distanceKm: 65 },
  { fromId: 2, toId: 3, distanceKm: 130 }
];
---

<html lang="es">
  <head>
    <meta charset="utf-8" />
    <title>BookingMx — Find the best stay</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
  </head>
  <body>
    <section class="hero">
      <div class="container">
        <h1 style="margin:0 0 .75rem 0;">Save up to 50% on your next stay</h1>
        <div class="grid">
          <input id="q" class="input" placeholder="Destination (e.g., Toluca)" />
          <input id="start" class="input" type="date" />
          <input id="end" class="input" type="date" />
          <input id="guests" class="input" type="number" min="1" value="2" />
          <button id="searchBtn" class="btn">Search</button>
        </div>
        <div style="margin-top:.5rem;">
          <span class="badge">Booking.com</span>
          <span class="badge">Expedia</span>
          <span class="badge">Trip.com</span>
          <span class="badge">Hotels.com</span>
        </div>
      </div>
    </section>

    <main class="container">
      <div id="results" class="card">
        <strong>Results</strong>
        <div id="list"></div>
        <div class="svg-wrap">
          <svg id="graph" width="720" height="520"></svg>
        </div>
      </div>
    </main>

    <script type="module">
      import { validateData, formatGraphForSvg, nearbyWithinRadius } from "../lib/graph/citiesGraph.js";

      const cities = JSON.parse(`${JSON.stringify(demoCities)}`);
      const edges  = JSON.parse(`${JSON.stringify(demoEdges)}`);

      // Render básico del grafo en SVG
      function renderGraph(cities, edges) {
        try { validateData(cities, edges); } catch (e) { console.error(e); return; }
        const svg = document.getElementById('graph');
        svg.innerHTML = '';
        const { nodes, links } = formatGraphForSvg(cities, edges);

        // Draw links
        for (const l of links) {
          const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
          line.setAttribute('x1', l.x1); line.setAttribute('y1', l.y1);
          line.setAttribute('x2', l.x2); line.setAttribute('y2', l.y2);
          line.setAttribute('stroke', '#c5c5c5'); line.setAttribute('stroke-width', '2');
          svg.appendChild(line);
        }
        // Draw nodes
        for (const n of nodes) {
          const c = document.createElementNS("http://www.w3.org/2000/svg", "circle");
          c.setAttribute('cx', n.x); c.setAttribute('cy', n.y); c.setAttribute('r', '8');
          c.setAttribute('fill', '#0a60ff'); c.setAttribute('opacity','0.9');
          svg.appendChild(c);

          const t = document.createElementNS("http://www.w3.org/2000/svg", "text");
          t.textContent = n.name; t.setAttribute('x', n.x + 12); t.setAttribute('y', n.y + 4);
          t.setAttribute('font-size','12'); t.setAttribute('fill','#333');
          svg.appendChild(t);
        }
      }

      function addList(sourceCityName = 'CDMX', radiusKm = 100) {
        const source = cities.find(c => c.name.toLowerCase() === sourceCityName.toLowerCase()) ?? cities[1];
        const ids = nearbyWithinRadius(source.id, radiusKm, edges);
        const near = cities.filter(c => ids.includes(c.id)).map(c => c.name);
        const list = document.getElementById('list');
        list.innerHTML = `<p><strong>Nearby from ${source.name} (&le; ${radiusKm} km):</strong> ${near.join(', ') || '—'}</p>`;
      }

      document.getElementById('searchBtn').addEventListener('click', async () => {
        // Aquí podrías llamar a tu backend con fetch(`${import.meta.env.PUBLIC_API_BASE}/hoteles?...`)
        // Por ahora usamos demo local para no exponer URLs.
        addList(document.getElementById('q').value || 'CDMX', 100);
        renderGraph(cities, edges);
      });

      // primer render
      addList('CDMX', 100);
      renderGraph(cities, edges);
    </script>
  </body>
</html>